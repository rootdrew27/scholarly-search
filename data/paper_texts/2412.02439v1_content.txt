SECTION: Nature versus nurture in galaxy formation: the effect of environment on star formation with causal machine learning
Understanding how galaxies form and evolve is at the heart of modern astronomy. With the advent of large-scale surveys and simulations, remarkable progress has been made in the last few decades. Despite this, the physical processes behind the phenomena, and particularly their importance, remain far from known, as correlations have primarily been established rather than the underlying causality. We address this challenge by applying the causal inference framework. Specifically, we tackle the fundamental open question of whether galaxy formation and evolution depends more on nature (i.e., internal processes) or nurture (i.e., external processes), by estimating the causal effect of environment on star-formation rate (SFR) in the IllustrisTNG simulations. To do so, we develop a comprehensive causal model and employ cutting-edge techniques from epidemiology to overcome the long-standing problem of disentangling nature and nurture. We find that the causal effect is negative and substantial, with environment suppressing the SFR by a maximal factor of. While the overall effect atis negative, in the early universe, environment is discovered to have a positive impact, boosting star formation by a factor ofatand by even greater amounts at higher redshifts. Furthermore, we show that: (i) nature also plays an important role, as ignoring it underestimates the causal effect in intermediate-density environments by a factor of, (ii) controlling for the stellar mass at a snapshot in time, as is common in the literature, is not only insufficient to disentangle nature and nurture but actually has an adverse effect, though (iii) stellar mass is an adequate proxy of the effects of nature. Finally, this work may prove a useful blueprint for extracting causal insights in other fields that deal with dynamical systems with closed feedback loops, such as the Earth’s climate.

SECTION: Introduction
In the local universe, there are two distinct broad populations of galaxies: the red sequence of massive, red, early-type, quiescent galaxies, and the blue sequence of less-massive, blue, late-type, star-forming galaxies. These two populations are unevenly distributed, with the red sequence mainly found in groups and clusters and the blue sequence located in relative isolation in the field. The fundamental question is then: is environment responsible for the bimodality?

Correlations between galaxy properties and environment are well established. For example, the morphology–density, colour–density, and star-formation rate (SFR)–densityrelations show a shift from late-type to early-type morphologies, an increase in the fraction of red galaxies, and a decline in the star-formation activity of galaxieswith increasing environmental density, respectively. However, “correlation does not imply causation”. Notably, stellar mass is also correlated with most galaxy propertiesand environment. Consequently, does galaxy formation and evolution depend on internal processes (i.e., ‘nature’) that scale with stellar mass or external processes (i.e., ‘nurture’) associated with environment? Resolving this nature versus nurture debateis a big open challenge in astronomy.

The current consensus is that both nature and nurture influence the evolution of galaxies. To isolate the effect of environment, previous studies have controlled for stellar mass, typically by binning galaxies. Here, most have found galaxy properties to still depend on environment. However, binning galaxies according to their stellar mass does not suffice to disentangle nature and nurture.

The dilemma (as in the original debate in biology) is that nurture likely influences nature and vice versa in a feedback loop, as galaxies interact with their environments and co-evolve over time. Thus, the distinction between nature and nurture is blurred. Furthermore, given the above, the evolutionary history of the galaxy population is likely necessary to separate the two components. However, observational data in the past were limited predominantly to the local universe due to the limitation of the then-available surveys. The advent of deep surveys has enabled the tracing of the galaxy population over time, but the data is still snapshots of galaxies, which ranks the lowest in a hierarchy of designs for evidence concerning causality. Consequently, the problem remains unsolved, and the individual causal effects of nature and nurture are not yet known.

We address this challenge by applying, for the first time to our knowledge, the causal inference framework in the overall context of galaxy formation and evolution. Causal inference is concerned with the identification and quantification of causal relationships (see Appendixfor a brief overview). With significant advancements made in the last few decades (; also see, for a review), the field is now well established and has been applied to answer crucial questions in economics, political science, education, policy, public health, and more recently, quantum mechanicsand quantum cryptography. Notably, causal inference methods are now starting to be adopted in astronomy, with applications to exoplanets, and in the past few years, galaxy formation and evolution. We combine causal inference with machine learning (ML) to handle high-dimensional and non-linear data. The tools of ML have increasingly been applied to problems in astronomy (; also see, for recent reviews), including causal insights into galaxy evolution. However, overall, ML on its own cannot infer causality as it is correlation-based.

Causal machine learningis an emerging field, but it has already been successful, e.g., in improving the accuracy of medical diagnosis (; also see, for a review of causal ML for healthcare). In this work, we apply causal ML to disentangle the roles of nature and nurture. Specifically, we establish the causal nature of the SFR–density relation in the IllustrisTNG simulations. We estimate the overall causal effect of environment on the SFR atand at different redshifts out toto determine how the role of environment has changed over cosmic time. Furthermore, we answer the fundamental questions:

Is stellar mass an adequate proxy of the effects of nature?

Is controlling for the stellar mass at a snapshot in time sufficient to disentangle nature and nurture and estimate the causal effect of environment?

Is nature important? Specifically, is galaxy formation and evolution top-down determined by environment with no reverse influence of nature?

SECTION: Causal model of galaxy formation and evolution
The gold standard for estimating causal effects is a randomised control trial (RCT;), but this is impossible in our setting. In the absence of experimentation, causal inference necessitates identifying and nullifying any biases present in observational data with expert knowledge andassumptions about the structure of the data-generating process (DGP) in the form of a causal structure, i.e., a model capturing the causal relationships between variables (referred
to as causal model for simplicity from here). Consequently, to estimate the causal effect of environment on SFR, we construct a causal model of galaxy formation and evolution.

We assume the cold dark matter (CDM) paradigm, in which galaxies form and evolve in dark matter haloes. To build our causal model, we review established theories of galaxy formation and evolution, and in particular ideas from semi-analytic modelling (SAM;; also see, for reviews), and express them as causal graphs. Briefly, we found galaxy formation and evolution to depend on both nature and nurture, with halo mass representing nature and environment related to nurture. See Appendixfor a full description of the construction of the causal model.

Fig.shows the causal model of galaxy formation and evolution (in the form of a causal graph). The causal model is complex and richly interconnected, with multiple interactions and feedback loops between the variables. Notably, halo mass (i.e., nature) and environment (i.e., nurture) are interacting with each other through accretion and mergers. Furthermore, internal processes driven by halo mass are affected by environment, and external processes linked to environment are dependent on halo mass. In other words, nurture influences nature and vice versa, and the effects of one depend on the other, i.e., nature and nurture are heavily intertwined. In this context, we define the nature versus nurture debate in this Article.

The presence of feedback loops in the causal model blurs the notion of causality. If two variables cause each other in a cycle, then what is the causal effect of one thing on another? Fundamentally, this fuzziness emerges due to a lack of a causal arrow of time, i.e., a cause precedes its effect. Thus, we unravel the feedback loops over time to make it easy to interpret and estimate causal effects, transforming the directed cyclic graph (DCG) into a directed acyclic graph (DAG).

SECTION: Causal DAG
We start by carefully going through the many paths between environment and SFR to identify any potential biases that may distort the causal effect (example causal path shown in blue in Fig.). Here, we find that halo mass is a fundamental common causeor confounder (ignoring initial conditions, which is shown as a token) of environment (i.e., the treatment) and SFR (i.e., the outcome) through various processes (example confounding path shown in red). This is an issue because if halo mass influences the environment (of a galaxy) and SFR, then what is the causal effect of environment versus that of halo mass? The presence of this “confounding bias” (Fig.) means that the correlation between environment and SFR does not translate to the causal effect. To determine the causal effect of environment on SFR, the influence of halo mass must be adjusted for. We carefully trace the causal chains and unravel the feedback loops present in the causal model to construct the DAG shown in Fig.a, which we refer to also as “causal model” from here. In the causal model, the causal chains of variables connecting the fundamental quantities have been condensed for visual clarity. More importantly, the adjustment set of only halo mass is both sufficient and necessary to estimate the causal effect on environment on SFR, according to the d-separation criterion. The figure also shows the naïve (b) and traditional (c) models, which we compare to our physics-informed causal model in Section.

The initial haloes and their environments emerge from the initial conditions in the early universe. Subsequently, they interact and co-evolve over time in a feedback loop, influencing galaxies in the process. The structure of the causal model is as follows:

Environment affects the SFR as: (i) ram-pressure stripping (RPS) and tidal stripping deplete the fuel necessary for star formation by removing the cold galaxy and hot halo gases and (ii) galaxy harassment impacts the galaxy gas density by impulsively heating the cold gas.

Halo mass dictates the amount and density of the cold gas for star formation as it indirectly influences the cooling rate and free-fall time via the halo gas temperature and density. Furthermore, it determines the susceptibility of a galaxy to environmental processes, which affects the SFR.

Intrinsically, the act of forming stars consumes gas, thus impacting the future SFR. Additionally, feedback as a consequence of star formation actively affects the SFR through the expulsion of hot halo and cold galaxy gases and suppression of the cooling process.

Halo mass and environment are determined by the halo accretion and merger rates, which ultimately depend on the previous halo mass and environment. Also, environmental processes such as tidal stripping affect the halo mass.

Accretion and mergers alter many halo and galaxy properties besides halo mass, which all converge on the SFR. In other words, there is a direct lagged effect of the previous halo mass and environment on the current SFR.

For an in-depth understanding of and reasoning behind the structure of the causal model, see Appendix. There are many causal effects in the causal model, then what is the causal effect of environment on SFR? We provide an explicit definition next.

SECTION: Causal effects
Environment affects galaxies over a period of time, so it is a time-varying treatment rather than a time-fixed treatment. There are many causal effects one can compute when the treatment varies in time, each providing an answer to a specific type of decision-making task. We define two types of causal effects:

The marginal causal effect is the effect of a single treatmenton outcome.

The joint causal effect is the effect of multiple treatments or treatment historyon outcome, where.

The marginal effect ofrepresents the short-term environmental impact, while the joint effect ofcaptures the long-term impact on SFR. We focus on the joint effect as we are interested in the overall impact and refer to it as the causal effect. We define the environmental history,

whereis the number of treatments and(see, for more complex characterisations). We note thatis used instead offor mathematical correctness in this equation and where necessary, but not in text for consistency. The joint effect ofrepresents the impact of average environment, which we de facto mean by the causal effect of environment.

As found above, there is confounding bias due to halo mass that must be negated to estimate the true causal effect of environment on SFR. First, consider the marginal effect ofon. There are two confounders,and, as they directly cause the treatment, and directly and indirectly (viaand) cause the outcome. Thus, we need to adjust for them to estimate the causal effect of the ‘current’ environment on the ‘current’ SFR. Intuitively, if the ‘previous’ halo mass and environment affect the current SFR, then their roles must be negated to determine the impact of only the current environment. We can achieve this by conditioning on them.

Now, consider the joint effect of,, andon. Once again,is a confounder of the causal effect ofon, so we must adjust for it. However, if we condition on the confounder, the causal effect ofonthat flows through it becomes blocked. As a result, the causal effect of environment on the SFR would be underestimated (in the positive or negative direction). In other words, if we attempt to eliminate confounding bias, then we introduce over-adjustment bias, and if we do not, the causal effect remains biased. More precisely, we cannot estimate the joint causal effect with the conditional approach because there is time-varying confounding and treatment-confounder feedback:is a time-varying confounder since it causes outcomeand the subsequent treatment, and there is treatment-confounder feedback asis affected by the previous treatment, i.e., the previous environment affects the current halo mass which then affects the subsequent environment in a cycle. The key takeaway is that simply adjusting for the halo mass and environmental histories is insufficient to disentangle nature and nurture.

In summary, estimating the causal effect of environment is difficult due to the interdependence of nature and nurture. The causal effects of nature and nurture are intertwined as the causal effect of environment partially flows through halo mass and vice versa. As a result, it is challenging to isolate the effect of one from the other without introducing bias. Conditional approaches cannot adequately separate the causal effects even if given all the necessary data. So, the challenge is not only of data but also methodological. We employ a marginal approach in the form of the Robins’ generalised method, inverse probability weighting (IPW) of marginal structural models (MSMs;), to disentangle nature and nurture. The method has been applied to conceptually similar problems in other fields, e.g., to study the effects of neighbourhood poverty on alcohol use. See Appendixfor a description of the method and definitions of the conditional and marginal approaches.

We combine IPW of MSMs with the random forest (RF;) algorithm and devise and implement an overall two-step estimation process on the IllustrisTNG simulations, specifically the TNG100-1 run. The dataset consists ofgalaxies traced over cosmic time with merger trees fromto the present day, and our environment proxy is the three-dimensional (3D) 10th nearest neighbour density. See Sectionfor a description of the galaxy sample and the estimation process. We estimate the overall causal effect of environment on the SFR atand at different redshifts back to(with a baseline at) to understand the role of environment over time. See Appendixfor validity of the results.

SECTION: Results
SECTION: Overall causal effect of environment
Fig.shows the causal dose-response curves (CDRCs) of the causal effect of environment on the SFR (i.e., causal SFR–density relations) atand at different redshifts going back to. The CDRC denotes the average response in the population if all units were subject to treatment. By comparing any two points on the curve, one can determine the mean change in the outcome if all units received, for example, treatmentinstead of. This difference in outcome is the average causal effect(ACE;). Here, the CDRCs represent the average SFR of galaxies if they inhabited, on average, the specific density environment over time. The bottom panel ofshows the ACEs of different density environments (comparing to the lowest-density environment, which we define as our baseline).

Focusing on, the CDRC is relatively flat up toand therefore the causal effect of environment is negligible. Subsequently, the CDRC trends downwards and the causal effect becomes negative as the average SFR decreases with increasing environmental density until. At even higher densities the impact of environment saturates, or possibly even weakens. We return to this point in Section. In brief, environment does not appear to influence the SFR at low densities, but at intermediate-to-high densities, it has a negative effect. However, the causal effect is not the strongest in the densest environments. Furthermore, there is a characteristic density () beyond which environment starts playing a role. This ‘break’ in the SFR–density relation has previously been remarked upon byand, who in fact reported the same value (albeit in projected 2D density). These authors identified the density to be typical of environments a few virial radii away from cluster centres, thus representing something of a transition from the field to more circum-cluster and group-like environments. Above all, the overall causal effect is negative and substantial, with environment suppressing the average SFR by a maximal factor of.

SECTION: Role of environment over time
The causal effect is at its most substantial atand weaker in the recent past, implying that the impact of environment accumulates over time. Bythe negative trend seems to start flattening, and somewhat surprisingly, fully reverses by. Beyondthe average SFR continues to increase with increasing environmental density, so the causal effect of environment on the SFR is positive. Furthermore, the effect is significant and becomes stronger with redshift, rising from a factor ofto overby.

The downtrend we find at low redshifts is consistent with observational studies, and typically interpreted as a result of processes in our causal model such as tidal stripping, RPS, dynamical friction, and galaxy harassment (see Fig.). But the uptrend at high redshifts is unexpected given that these same physical processes should operate in dense environments regardless of cosmic epoch. Having said that, studies have been inconsistent in their findings, and there remains an active debate on whether the SFR–density relation, as observed in the local universe, exists at intermediate () to high redshifts (). Some studies have found that the relation persists in the early universe, others have evidenced a flattening, while others yet have noted a reversal. The lack of consistency between the studies is due to a multitude of reasons, beginning with the ambiguity around the SFR–density relation itself. The term is loosely used in the literature and is polysemous, as studies have analysed the specific star-formation rate ()–density, colour–density, and star-forming/quiescent fraction–density relations under the SFR–density relation moniker. These quantities, while related, are fundamentally different and cannot be compared. Another point for contention is the data or lack thereof. Deep surveys observe a small patch of the sky, so such studies are often susceptible to cosmic variance. Lastly, since there is no universal definition of environment, the choice of measure is possibly responsible for part of the disagreements.

It is difficult to draw parallels between the literature for all the aforementioned reasons, but the most critical aspect is that the analyses have been largely statistical rather than causal in nature. Regardless, both observationaland simulation studieshave found SFR–density reversals (albeit at a weaker level) independent of the stellar mass correlation, thus supporting a positive impact of environment. Additionally,andobserved the uptrend strengthening with redshift, as we do here. The consistency of our results, within particular, given that they also used the TNG simulations (though the larger volume TNG300 instead of TNG100), is strong evidence for the reliability of our method and study.

Assuming that IllustrisTNG provides a reasonable reflection of reality, a possible explanation for the positive causal effect of environment in the early universe is that denser environments have a larger reservoir of material from which to form stars. As a result, galaxies in such environments are able to accrete more gas more quickly and sustain higher SFRs. This seemingly simple and obvious statement belies the complexity around how we choose to compare galaxy populations occupying different environments and what we mean by a galaxy’s ‘nature’. We will elaborate this point in the next section. Naturally, high-density environments at low redshift also contain a greater abundance of matter than lower-density regions. The key difference is that in the late universe a far greater fraction of the gas is maintained in the form of hot gas, inaccessible for star formation. The above, combined with the absence of negative processes in the early universe typically associated with environment, as groups and clusters are still forming, can explain the positive effect.

Another potential cause is major mergers, which are more likely in dense regions at high redshiftswhen the velocities are not too extreme. An influx of cold gas in a gas-rich galaxy merger can trigger a galaxy-wide starburst (though clearly this channel will not explain the entire factorenhancement measured at the highest redshift). Nonetheless, for a definitive answer, the causal effect of individual environmental processes must be estimated. The critical work has been done with the construction of a comprehensive causal model (Fig.). Using this model, one can extend our analysis to estimate the causal effects of different processes.

We stress that the positive trend is not just a consequence of the fact that massive galaxies are preferentially found in denser environments. Rather, what we are seeing is a reflection of the well-established galaxy “downsizing”, in which the most massive galaxies form early and quickly, and barely evolve thereafter (; also see, for a detailed discussion). Our measurements explain downsizing as a consequence of environment-driven accelerated evolution of galaxies in dense environments rather than high-stellar mass galaxies directly causing their own high SFRs and subsequent quenching.

SECTION: Model comparison
We now place our results into a wider context by comparing our causal model to others. We answer the following critical questions: (i) is nature important? Specifically, is galaxy formation and evolution top-down dominated by environment with no reverse influence of halo mass? (ii) is controlling for the stellar mass at a snapshot in time sufficient to disentangle nature and nurture and estimate the causal effect of environment? and (iii) is stellar mass an adequate proxy of nature?

We first consider the possibility of no confounding. In our causal model, halo mass is the confounder as it causes environment and SFR. However, in order to answer the first of our key questions it is useful to consider a universe in which this is not the case, one in which environment completely dominates the evolution of a galaxy and halo mass has no reverse influence on environment. In this scenario, the raw correlation between environment and SFR is the unbiased causal effect of environment, and one does not need to adjust for nature. We represent this as the naïve model (Fig.b).

Next, we mimic previous studies, that is we adjust for the stellar mass at a snapshot in time to estimate the causal effect of environment. The method supposes the causal model illustrated in Fig.c, in which stellar mass () is the confounder. Obviously, stellar mass does not cause environment and SFR, but this is nevertheless the model implicit in the literature. In fact, stellar mass may be an effect of both, as per our causal model, so adjusting for the variable could induce selection bias (Fig.) instead of negating confounding bias (see “Processing steps” in Sectionfor a more detailed discussion). Furthermore, the model fails to capture dynamic systems with feedback loops that galaxies ultimately are. The lack of a framework to infer causality, combined with the shortcomings of observational data, has meant that controlling for the stellar mass at a snapshot in time has been the only practical and logical option (given that stellar mass should correlate with internal processes) to disentangle nature and nurture, even though it has been demonstrated bythat this is insufficient. We refer to this model as the traditional model.

Finally, we assume our physics-informed causal model (Fig.a), but on this occasion, we substitute stellar mass for halo mass as the time-varying confounder. Our goal is to answer the question: is stellar mass a suitable proxy of nature (halo mass) given a valid causal model and method to disentangle nature and nurture? This is important because halo mass (not host halo mass) is challenging to infer observationally. Fig.shows the CDRCs of the causal effect of environment on the SFR atfor the aforementioned models, compared to the causal model (labelled as “causal model (halo mass)”). The bottom panels show the difference in the average SFRs between the models. We focus onas we are primarily interested in the difference in the overall causal effect.

The CDRCs of the naïve and causal models are different (Fig.a), which implies that the halo mass of a galaxy influences the environment it inhabits. Breaking it down further, the CDRC of the naïve model is above the causal model’s up to, which signifies that halo mass has a positive effect on the SFR because, post adjustment, the average SFR is lower. The probable explanation is that at low-to-intermediate densities, a larger halo is able to accrete more gas from its surroundings which, up to a certain extent, translates to enhanced star formation. Between, there is no discernible difference between the two models, so halo mass has no effect on environment in this density regime (assuming it impacts the SFR). In the host halo mass–environment distribution in,in average density probably corresponds to large group and cluster host haloes, where environment is indeed believed to dictate galaxy evolution. Naturally therefore, the causal effect of environment is the largest in this density regime.

Beyondthe models diverge again, but it is difficult to conclude whether halo mass impacts environment due to the noise and limited data. Nonetheless, a possible explanation may lie in the fact that the density regime (primarily) corresponds to central regions of massive groups and clusters, given that the ratio of the number of central galaxies to satellites is comparatively larger than in the prior density range, as can be observed in. The centre of a host halo is a special location, where a galaxy is not subject to some of the environmental processes that satellite galaxies are, and may also potentially be able to have some influence. This also explains the weaker environmental impact on SFR in the density regime. Also, central galaxies at the bottom of the potential well may be recipients of gas for star formation in the case of cool-core clusters. The dichotomy between central and satellite galaxies could be explored within our causal framework by using aneffect modificationand adapting IPW of MSMs to estimate the separate causal effects of environment on these two object classes. However, doing so is rather involved and we leave this for future work.

In conclusion, nature is important and galaxy formation and evolution is not simply top-down determined by environment. The environment affects halo mass, but halo mass has an influence on the environment a galaxy inhabits as well. Ignoring the role of nature by not adjusting for halo mass leads to the causal effect in intermediate-density environments being underestimated by a factor of. A potential future study would be to estimate the causal effect of halo mass on SFR to finally answer the long-standing question: which is more important, nature or nurture?

The CDRC of the traditional model is largely identical to the naïve model’s except in the high-density regime (inset of Fig.b), so adjusting for the stellar mass at the single redshift of observations has mostly had no effect. It has not disentangled the effects of nature and nurture and is therefore insufficient to estimate the causal effect of environment. In fact, the traditional model overall deviates further from the assumed truth (i.e., the causal model) than the naïve model, so adjusting for the stellar mass at a snapshot in time actually has an adverse effect. The failure of the traditional model is also indicated by the skewed weight distributions in Fig., with mean values farther from one compared to the causal model’s (Fig.).

We remark that the traditional model also predicts a positive causal effect of environment at high redshifts (Fig.), as opposed to a flattening observed by many previous observational studies. The uptrend is weaker compared to the causal model, but it is present nonetheless, especially atand. The result further confirms that the positive trend observed with the causal model is not simply due to massive galaxies in denser environments that form more stars because we adjust for this fact by controlling for stellar mass with the traditional model.

While there are minor differences (primarily at high densities), the CDRCs of causal model (halo mass) and causal model (stellar mass) are similar overall, as further highlighted by the minimal deviations of the residual curve (Fig.c). Consequently, we conclude that stellar mass is an adequate proxy of halo mass and thus nature. This finding is important because unlike a galaxy’s halo mass, its stellar mass can be readily inferred observationally, and the ultimate goal of this study is to estimate the causal effect of environment on galaxies in the real universe. Evidently, the lack of evolutionary histories of galaxies observationally, or more specifically, the halo/stellar mass and environmental histories, is a major hurdle. On this front, star-formation histories (and thus stellar mass histories) can be recovered by modelling and fitting spectral energy distributions, and recently,employed the extended Fast Action Minimization (eFAM) method to reconstruct the environmental history of galaxies. Consequently, it is feasible to estimate the real causal effect (on star formation at least).

SECTION: Conclusions
Our understanding of galaxy formation and evolution has advanced significantly in the past few decades as an overall picture has been pieced together. Having said that, the underlying processes responsible for the observed phenomena, and especially their importance, are still not fully known, as establishing causality from correlations has proven challenging. Here, simulations have provided some insights, but the causal effect itself is intractable given the high degree of complexity. In this Article, we have addressed this by adopting the causal inference framework. In particular, we have tackled the long-standing problem of disentangling the roles of nature (i.e., internal processes) and nurture (i.e., external processes) on the formation and evolution of galaxies and estimated the causal effect of environment on star-formation rate (SFR) in the IllustrisTNG simulations. To achieve this, we developed a comprehensive causal model from the ground up and employed advanced techniques from epidemiology.

We have found that the causal effect is negative and substantial, with environment suppressing the SFR by a maximal factor of. However, while the overall effect atis negative, we have discovered that in the early universe (), environment had a positive impact. Furthermore, the causal effect is significant, with environment boosting star formation by a factor ofatand by even greater amounts at higher redshifts. This challenges the consensus that environment always acts to inhibit star formation. Our results require a broader view of what we mean by the impact of environment, and are an expression of the well-known phenomenon of galaxy “downsizing”. We also reveal that:

Nature (associated with halo mass) is important. Specifically, galaxy formation and evolution is not top-down determined by environment as the environment affects halo mass, but halo mass has an influence on the environment a galaxy inhabits as well. Ignoring the role of nature leads to the causal effect in intermediate-density environments being underestimated by a factor of.

Controlling for the stellar mass at a snapshot in time, as is common in the literature, does not disentangle nature and nurture. Not only is it insufficient to estimate the causal effect of environment, but it actually has an adverse effect. We remark that the causal effect estimated this way at high redshifts is still positive, though reduced in magnitude. Overall, snapshot studies are inadequate, and the evolutionary history of galaxies is required.

Nevertheless, stellar mass is a sufficient proxy of the effects of nature (i.e., halo mass), assuming our causal model is valid and given stellar mass history and method to disentangle nature and nurture.

With the introduction of a theoretical framework to infer causality and a potential solution to the challenging nature–nurture problem, this work paves the way towards unravelling some of the biggest questions in galaxy formation and evolution, such as: what drives galaxy quenching, are environmental processes responsible for the morphological transformations of galaxies, what is the impact of supermassive black holes (SMBHs) on their host galaxies, and the question at the heart of this Article, which is more important: nature or nurture? The timing is opportune as the field is entering the era of “Big Data” with the next generation of large-scale surveys coming online, such as Euclid, the Rubin Observatory Legacy Survey of Space and Time (LSST;), and the Nancy Grace Roman Space Telescope (Roman Space Telescope;). These surveys have the power to measure the correlations to exquisite precision, and thus hold great promise in teasing out subtle patterns that are currently hidden. However, a causal framework, such as the one we have presented, will be necessary to determine the underlying mechanisms and their effects to truly understand how galaxies have formed and evolved.

SECTION: Methods
SECTION: Galaxy sample
According to the causal model and method, we require the evolutionary history of galaxies to disentangle nature and nurture. Such data is not readily available observationally, so we rely on simulations, which enable the tracing of galaxies over time using merger trees. In particular, we utilise the IllustrisTNG simulations.

IllustrisTNG (hereafter TNG) is a suite of cosmological, gravo-magnetohydrodynamical (MHD) simulations run with the moving-mesh code. TNG adopts a flatcosmology withcosmological parameters (). The simulations start atfrom initial conditions created with the Zeldovich approximationand thecode. There aresnapshots of each simulation, approximately equally spaced in cosmic time fromto the present day. For our analysis, we use the highest resolution run of the TNG100 simulation, TNG100-1. The simulation is initialised withdark matter and gas particles of mass resolutionsand, respectively.

First, we select a sample of galaxies to trace over time as follows. We start with the group catalogue at, which containsfriends-of-friend (FoF;) haloes andsubhaloes. We match each subhalo to its FoF halo using thefield, which results inFoF haloes (i.e., more than half of FoF haloes do not have any subhaloes). There are some subhaloes of non-cosmological origin, which means they have not formed due to the process of structure formation and collapse and are likely fragments or clumps rather than bonafide galaxies. We discard these objects by setting. Finally, we remove any subhaloes with no detectable dark matter and retain all galaxies with stellar mass, resulting ingalaxies. We chose the relatively high stellar mass cut to trace galaxies further back in time.

There is a possibility that applying the stellar mass cut introduces selection bias since stellar mass may be a common effect of both environment and SFR. One can interpret this as survivor bias (a form of selection bias) since we are selecting galaxies that made it to the stellar mass at the ‘end’ of the galaxy formation and evolution process. In the model, there is a causal connection between SFR and stellar mass, as well as environment and stellar mass, but significantly only the former is direct, while the latter is indirect through SFR. There is a ‘direct’ connection via galaxy harassment and tidal stripping between environment and stellar mass, but it is likely to be weak in comparison and not universal. Consequently, we reason that selecting galaxies based on their stellar mass atdoes not bias our analysis. Indeed, preliminary tests supported this as different stellar mass cuts were applied, and it was found that while the amplitude of the SFR–density relation changed, the shape did not. In other words, the causal effect remained unmodified.

We track the selected galaxies back in time withmerger trees. The merger tree of a subhalo can have many branches if its progenitors have undergone mergers. We follow the main progenitor branch (MPB), which traces the most massive progenitor at each point in time. For the analysis, we useapproximately equally-spaced snapshots in cosmic time fromto(i.e., snapshots). We decided uponas the baseline because it was the furthest we could trace most galaxies back in time. The average timespan between each snapshot isGyr. After all the preprocessing steps, the galaxy sample containsgalaxies.

There are different measures available of halo and galaxy properties. In our analysis, we use the quantities derived by summing all particles/cells bound to a subhalo associated with the particular property. The choice of measure does not impact our results because our questions are causal rather than statistical in nature. For the same reason, we stick with instantaneous SFRs measured in the simulations instead of using time-averaged SFRs that better match SFRs estimated observationally with various tracers. Due to the finite numerical resolution of the simulation, the instantaneous SFRs of galaxies are unresolvable if they are below the minimum value offor TNG100. The SFRs of such galaxies are labelled zero, which could cause numerical issues when estimating the causal effect. Following, we resolve the problem by randomly assigning an SFR value betweenand.

There are many definitions of environment in the literature, but the most popular are nearest-neighbour-based and fixed-aperture-based measures. The former best probe the ‘local environment’, while the latter the ‘large-scale environment’. Simply put, there is no universal definition of environment, and the most suitable method is scale dependent. As we are interested in the impact of the local environment, our environment proxy is theth nearest neighbour density,

whereis the three-dimensional (3D) distance to theth nearest neighbour from the galaxy in question. Specifically, we compute densities at the 10th nearest neighbour, which is a popular choice in the literature. We note that a rough analysis was performed with a range of nearest neighbours from. Below, the SFR–density relation was found to be noisy and flat, and thereafter, it became more stable and negative with increasing. These preliminary results indicate that the causal effect of environment varies at different scales. Most subhaloes in the simulation are small and dark (i.e., do not possess any galaxies), so considering the entire population would result in a noisy density measure. For a more informative estimate, we remove such subhaloes by applying the same cuts as when selecting the galaxy sample, but we do not apply the stellar mass cut at. Instead, we drop subhaloes with no detectable stars. We remark that we considered using host halo mass as a proxy since many environmental processes are either a consequence of it or scale with it. However, we ultimately decided against it because it is not a fine-grained measure of environment and its effects, and due to conceptual as well as practical issues.

Following our naming convention, FoF haloes and subhaloes are host haloes and haloes in our causal model respectively, so we refer to them and the associated properties accordingly from here onwards.shows the relationships between fundamental halo and galaxy properties, such as host halo mass, halo mass, stellar mass, and SFR, as well as the average environmental density of the galaxy sample at. A clear positive correlation can be observed between host halo mass and the 10th nearest neighbour density, which suggests that the latter is a suitable measure of environment, at least to the first order. As expected, the SFR overall decreases with increasing environmental density.

SECTION: Estimation process
We apply inverse probability weighting (IPW) of marginal structural models (MSMs;) to disentangle nature and nurture and estimate the causal effect of environment on SFR. IPW is a statistical technique to adjust for confounding and estimate causal effects. As the name suggests, the basic premise is to weight each unit according to the inverse of their probability of receiving treatment, i.e., the propensity score (PS;), to create a pseudo-population in which the treatment is independent of confounders. Overall, IPW of MSMs involves: (i) estimating weights to adjust for biases and (ii) fitting a MSM using the weights to estimate causal effects (see Appendixfor a more detailed description and explanation of the method). Weights can be estimated directly from data if the treatment and confounders are binary or categorical variables and there are a limited number of them. In our case, environment and halo mass are inherently continuous variables, and we suffer from the curse of dimensionality withtotal snapshots, so direct estimation is not feasible. Additionally, we cannot fit a parametric MSM to estimate causal effects since the causal relationship between environment and SFR is unknown. We apply ML for both tasks, which allows us handle the high-dimensional data and model the potentially non-linear relationships between halo mass, environment, and SFR. Specifically, we employ the random forest (RF;) algorithm as it has already been shown to perform the best (out of the algorithms compared) in estimating propensity scores.

We define two types of models:

– the input features and target variable are the confounders and treatment, respectively. The model output is the expectation of treatment given confounders,.

– the input feature and target variable are the treatment and outcome, respectively. The model output is the expectation of outcome given treatment,.

As the names suggest, the weighting and outcome models estimate weights and MSMs, respectively. We devise the following multi-step estimation process:

Train a weighting model.

Predict the treatment of each unit with the weighting model to estimate the propensity score.

Repeat the above steps, but now to estimate the numerator.

Construct weights.

Train an outcome model with each unit weighted.

Predict treatment outcomes with the outcome model to estimate causal effects.

In the causal model, the previous halo massand environmentaffect the current environmentand star-formation rate. Therefore, it is necessary to adjust for them at each time point to eliminate confounding bias. We go a step beyond and adjust for the entire previous halo mass and environmental histories (and) as a precautionary measure to account for any direct lagged effects of halo mass and environment that may hypothetically exist from further back in time. Taking everything into consideration leads us to the weights at time point,

adapted from the general form for time-varying treatments (equation;). The numerator is the conditional probability density function (PDF) of the current environment given the previous environmental history, and the denominator is the conditional PDF of the current environment given the previous environmental and halo mass histories.

We estimate the propensity score (i.e., the denominator) as follows. We train a weighting model with the previous halo mass and environmental histories as the inputs and the current environment as the target. Once trained, we predict the current environment with the model, which is the. Subsequently, we construct a normal distribution with the mean set to the prediction and the standard deviation equal to that of the residuals. Finally, we evaluate the density function at the true value.

We estimate the numerator following the same process. In the weighting model, we input the previous environmental history, with the target once again the current environment. The model output is the. We train separate weighting models to estimate the weights at each time point. The exception beingbecause there is no prior confounding by default as it is the baseline snapshot. The weights at the redshift are equal to one. We note that we have assumed the conditional PDFs follow the normal distribution to estimate the densities. Also, we trained and predicted on the same dataset because our goal is causal inference, not prediction.

Finally, we construct the weights according to equation () and incorporate them in outcome models to estimate the causal effect of environment. As our environment proxy, the 10th nearest neighbour density, is a continuous variable, we estimate causal dose-response curves (CDRCs) rather than single causal effects. For this, we define a grid oftreatment values between the 1st and 99th percentiles of the treatment distribution and predict with outcome models.

We first focus onto understand the overall effect. We train an outcome model with the average environmentand the star-formation rateatas the input and target, respectively. Once trained, we predict the final SFR at different average environments to estimate the CDRC. The weights applied are the product of weights at all redshifts, and the model prediction is the. Next, we extend our analysis to all the redshifts to determine how the role of environment has changed over time. We bootstrapped the entire estimation process to obtain confidence intervals around the CDRCs. This resulted in weighting models predicting a few extreme weights, probably due to the limited sample size. Given that they could drastically skew the causal effect, we trimmed the weights at the 1st and 99th percentiles.bootstrap samples were used.

We utilised theML Python package to train the RF models, specifically themodule. In regards to hyperparameter tuning, we kept the defaults and only coarsely tuned, which is the minimum number of samples in a leaf node. Our primary motivation was to best reduce the noise in the CDRCs due to: (i) the non-linear nature of RF and (ii) extrapolation beyond the training data. We found that the combination ofandfor the weighting and outcome models performed the best out of a limited parameter space, respectively. Consequently, we trained all the models with the aforementioned values.

The first step of the estimation process is skipped as no bias adjustment is necessary and unweighted outcome models are directly trained to learn the SFR–density relation. An outcome model is trained for each time point with environmentand star-formation rateas the input and target, respectively.

For the traditional model,

following the general form for time-fixed treatments (equation;). In the weighting models, the input is the stellar mass, and the target is the current environment. We highlight that we only input the current stellar mass and not the stellar mass history into the models, unlike in the causal model case, where we had input both the halo mass and environmental histories. The weighting models are then used to estimate the conditional densities. The marginal densitiesare determined via kernel density estimation (KDE), and no further models are trained. Finally, the weights are constructed with both densities and incorporated into outcome models. The time-point weights are not multiplied together to form the final product weights, but rather they are applied separately to replicate the previous analyses. We train two outcome models, one with the snapshot environment and the other with the average environment, for a like-to-like comparison with the previous studies and consistency with our results, respectively. The CDRCs from the former are shown in Fig., while the latter is plotted in Fig.b.

Same as the causal model’s, but now with stellar mass as the time-varying confounder instead of halo mass.

Acknowledgements
S.M. was supported by the STFC UCL Centre for Doctoral Training in Data Intensive Science (grant ST/P006736/1). O.L. acknowledges STFC Consolidated Grant ST/R000476/1 and the hospitality of All Souls College and the Physics Department, Oxford.

Author contribution S.M. conceived and led the study, working on data curation, analysis, figures (with inputs from all the authors), and validation. S.M. and W.G.H. developed the causal model of galaxy formation and evolution, interpreted the results, and wrote the Article. S.M. and C.M.L. worked on the methodology, with the latter supervising the application of causal inference to astronomy. O.L. provided inputs on the text and figures and, more broadly, the ‘big picture’. All authors discussed, reviewed, and edited the Article.

Supplementary information is provided.

Data availability The data used in this study will be made available upon request.

Code availability The code used in this study will be made available upon request.

Competing interests The authors declare no competing interests.

Correspondence and requests for materials should be addressed to S.M.

SECTION: References
SECTION: Causal inference
Causal inference is concerned with inferring cause and effect. The goal is to identify and quantify the causal effect of one thing on another, e.g., a vaccine on a disease. A correlation between the vaccine and outcome (disease cured or not) hints at its effectiveness but does not guarantee it as “correlation does not imply causation”. The observed correlation can be due to a common causethat causes both the vaccine and outcome. For example, age is a potential common cause as it typically influences whether an individual can receive a vaccine and their chance of recovery from a disease. In the extreme case, there may not be a causal connection between the vaccine and outcome, and the correlation may be entirely due to age, which would signify that the vaccine is ineffective. However, if the vaccine has a causal effect on the outcome, the correlation will be partly due to age and the vaccine. Regardless of the situation, the measured effectiveness of the vaccine without considering age will be biased. Herein lies the fundamental difference between statistical and causal inference: the former ascertains a relationship between two quantities (assuming one exists), while the latter can establish the causal nature of the relationship. In this section, we give a brief overview of causal inference, starting with its key tenets: causal models and causal graphs. We note that since “correlation” technically only refers to the degree to which a pair of variables are linearly related, we will use the broader term “association” from here to refer to statistical dependence because it describes any relationship between variables, linear or not.

SECTION: Causal models and graphs
The principal component for any causal inference task is a causal model or structural causal model (SCM), i.e., a model that describes causal relationships between variables. Formally, an SCM specifies a set of exogenous, or latent, variablesdistributed as, a set of endogenous, or observable, variables, a directed acyclic graph (DAG), called thecausal structureof the model, whose nodes are the variables, and a collection of functions, such thatwheredenotes the parent observed nodes of an observed variable. The collection of functions and distribution over latent variables induces a distribution over observable variables:. We can thus assign uncertainty over observable variables despite the fact the underlying dynamics are deterministic.

Structural equations () fully capture and mathematically describe a causal model. However, a graphical representation of a causal model in the form of causal graphs (also called causal diagrams) is more intuitive for understanding causal relationships. A causal graph is a probabilistic graphical model and consists of a collection of nodes and edges that connect the nodes. The nodes represent variables, while the edges communicate the causes of the variables. Fig.shows the fundamental causal graph between two variables,and. The direct edge (black arrow) fromtoimplies thatdirectly causes. The causal graph is an example of a DAG because: (i) it is directed (i.e., has edges that imply a direction) and (ii) acyclic (i.e., a variable does not cause itself either directly or through another variable).

DAGs make it easy to deduce if two variables share a causal or non-causal relationship. More importantly, they allow one to effortlessly conclude if association is causation with a few basic rules. For example, causal association (i.e., the association due to causation) can be imagined as ‘flowing’ asymmetrically along directed paths (a sequence of adjacent nodes with direct edges all in the same direction), while association ‘flowing’ symmetrically along directed paths. In the DAG in Fig., the causal association flows in one direction fromtoalong the direct path (as shown by the blue dashed line arrow). However, the association flows in both directions along the same path (as shown by the red dashed line). Hence, association alone does not provide any information on the direction of causality. It does not distinguish between the following possible causal relationships between the two variables:

causes(direct causation)

causes(reverse causation)

andshare a common cause (common causation)

andcause each other (cyclic causation)

Furthermore, it is also possible thatandare not related at all, and the association is coincidental. Consequently, association does not imply causation. Nevertheless, the DAG in this instance conveys that all association is causal as there is only a solitary direct path betweenand. If the DAG represents the true causal model of the vaccine–disease example, whereis the vaccine andis the outcome, the observed correlation does imply causation. In the following section, we describe the mathematical framework we adopt for reasoning and quantifying causality.

SECTION: Causal framework
The Rubin causal model, also known as the Neyman–Rubin causal model, is a mathematical framework of causal inference based on the idea of potential outcomes. The framework is inspired by how humans reason about causality. We compare an outcomegiven an actionwith the outcome under no action. If there is a difference in the two outcomes, we reason that the action has had a causal effect on the outcome. The individual causal effect (ICE) on a unit,

whereandare the two potential outcomes under action and no action, respectively. It is impossible to know both potential outcomes given that the two potential realities, the one in which the action takes place and the other in which it does not, cannot be observed simultaneously. The potential outcome that is observed is “factual”, whereas the unobserved potential outcome is “counterfactual”. This dilemma is the “fundamental problem of causal inference”. The impossible nature of the task is the reason why causality is such a challenging subject to tackle. Nevertheless, it is possible to estimate rather than compute causal effects. Generally, it is difficult to accurately estimate unit-level causal effects, but it is feasible to reliably estimate an average of the causal effect within a population—the average causal effect (ACE;),

We make the reader aware of the terminology we use throughout the Article: the actionis the quantity we are interested in measuring the causal effect of, and the outcomeis the quantity we want to measure the causal effect on. Furthermore, the action is sometimes referred to as an intervention, an exposure, or a treatment, depending on the scientific nature of the study. We refer to the action as the treatment.

SECTION: Causal assumptions
Causal inference necessitates the following assumptions:

– the potential outcomes are independent of the treatment.

– the probability of receiving treatment is greater than zero but less than one.

– the treatment is well-defined such that the observed outcome is equal to the potential outcome under treatment.

– the potential outcome of a unit only depends on its treatment and not on the treatment of other units.

The exchangeability assumption states that potential outcomes must be independent of the treatment. In other words, it must be possible to exchange treatment groups without changing their potential outcomes. To understand why the assumption is essential, consider the aforementioned vaccine–disease example, with age as a common cause. If age influences who receives the vaccine, then the treatment and control groups are not exchangeable because their age distributions are dissimilar. And if age also impacts one’s ability to recover from the disease, then the causal effect estimated using the groups is biased as it is an admixture of the causal effects of the vaccine and age. Exchangeability ensures that the causal effect is bias-free because if the treatment groups are similar in all of their characteristics except for the treatment, then any outstanding causal effect must be the result of the treatment only.

Positivity states that there must be a non-zero probability of receiving any treatment. This assumption is important because its violation leads to undefined causal effects. For example, consider the situation where everyone or no one receives the vaccine. In such a scenario, the causal effect of the vaccine would be mathematically impossible to estimate because the counterfactual would always be missing. Intuitively, causal effects are only meaningful if the outcome under “treatment” is contrasted to the outcome under “no treatment” within the potential outcomes framework of causal inference.

Consistency states that the observed outcome must equal the potential outcome under treatment. When this assumption is not met, the causal effect is inconclusive. Following the vaccine–disease example, there must be only one version of the vaccine if the goal is to estimate its efficacy. If multiple versions exist and they are labelled as the treatment, then the causal effect will be a mixture of the individual causal effects of the different vaccines. Furthermore, if the temperature of the vaccine affects the outcome, then all individuals must receive the vaccine at the same temperature. Simply put, the treatment must be well-defined.

Lastly, the no interference assumption states that the potential outcome of a unit must only depend on its treatment. Violation of this assumption makes the causal effect of treatment ill-defined in the strict sense because the treatment is now an admixture of multiple units’ treatment and must be redefined. This situation is common in many real-world cases and is referred to as spillover effects. For example, the likelihood of contracting COVID-19 depends not only on one’s immunity to the disease but also on the immunity within the population.

The consistency and no interference assumptions are sometimes grouped into the so-called stable unit treatment value assumption (SUTVA;) because their violation results in ill-defined causal effects. If all of the above assumptions are met, the ACE is identifiable and is the statistical quantity,

We explain these causal assumptions in detail in the context of our study in Appendix.

SECTION: Biases and adjustments
The gold standard for causal inference is a randomised control trial (RCT;). A well-conducted RCT outputs a true measure of the ACE because the causal assumptions are met by construction. However, it is not always possible to perform RCTs because they can be unethical, infeasible, or outright impossible. More often than not, only observational data is available that is prone to many biases, unlike experimental data. The biases violate the causal assumptions and distort the true causal effect. Here, causal graphs truly come into their own as they make it easy to identify such biases and adjust for them such that the causal assumptions hold, resulting in valid estimates of the causal effect. There are many different types of biases, but the primary two are confounding bias and selection (or collider) bias.

Confounding bias arises in the presence of a common cause or confounderthat causes both the treatment and the outcome, as illustrated in Fig.. Unlike the DAG in Fig., there are two paths for association to flow betweenand: (i) the direct path betweenandand (ii) the backdoor path linkingandvia. The causal association flows through the former, and the non-causal confounding association flows through the latter. The amalgam of causal and non-causal associations means association is not causation, and the causal effect is biased. Specifically, the causal effect is an admixture of the causal effects of the treatment and confounder. Intuitively, if age influences the treatment and outcome in the aforementioned vaccine–disease example, then it is difficult to separate the causal effect that age has on the outcome from the causal effect of the treatment. In terms of the causal assumptions, the presence of confounders violates exchangeability because the treatment is not independent.

In experimental data, confounding is not an issue as RCTs remove its effect via randomisation of the treatment. In DAGs, treatment randomisation translates to removing the direct edge fromto, makingindependent, so confounding association cannot flow via the backdoor path as it does not exist. As a result, association is causation because exchangeability holds, and the causal effect does not suffer from confounding bias. In contrast, confounding is a major issue in observational data because, by its nature, the treatment is not randomised beforehand via experimentation. The goal with observational data is not to solve the issue directly but rather to negate it by adjusting the data such that the estimates of causal effects are bias-free. The first step is to modify the causal assumptions to be appropriate for observational data. For example, conditional exchangeability must hold for observational data, as the prevalence of confounders will always violate exchangeability. Conditional exchangeability states that potential outcomes are independent of the treatment given confounders.

Visually, conditioning on a confounder blocks the non-causal confounding association from flowing fromtovia the backdoor path, as shown in Fig.b, leaving only the causal association. Also, as exchangeability and confounding are intertwined concepts, the conditional exchangeability assumption is sometimes referred to as unconfoundedness. An alteration of the positivity assumption is also necessary to account for confounding. Following on from the original definition, the conditional probability of receiving treatment given confounders must be greater than zero and less than one.

Given the prior consistency and no interference assumptions, in addition to conditional exchageability and positivity, the ACE

This is known as the adjustment formula because adjustments are made post-data generation to infer true, unbiased causal effects.

While confounding bias persists when there is a lack of adjustment of a common cause, selection bias occurs precisely due to adjustment of a common effect, as illustrated in Fig.. A common effect is a variable that is caused by both the treatment and the outcome. As previously, there is a direct path and a backdoor path betweenandfor association to flow. The causal association flows through the former as before, but the non-causal association does not flow through the latter as it is now a blocked path. The flow of association fromand‘collides’ on, as shown in Fig.a. Hence,is also referred to as a collider. In this scenario, association is causation, and the causal effect is not biased. By incorrectly conditioning on, the backdoor path is unblocked, allowing the non-causal association to flow as shown in Fig.b, which ultimately induces selection bias.

Continuing the vaccine–disease example: assume the vaccine has side effects and can cause hospitalisations in rare cases. The disease can also cause hospitalisations by deteriorating the health of individuals. Fig.represents this exact situation, where hospitalisationis the common effect of the vaccineand disease. Conditioning onby selecting only the hospitalised patients induces a non-causal association between the vaccine and disease. Specifically, a positive association between the vaccine and disease would be observed as the hospitalised population is more likely to be vaccinated or have the disease than the general population. The conclusion that one would draw from the selected data is that the vaccine causes the disease, which would be detrimental as it would dissuade people from receiving the vaccine. In terms of the causal assumptions, conditioning or selecting on the common effect also violates exchangeability.

SECTION: Constructing the causal model of galaxy formation and evolution
In this section, we construct a causal model of galaxy formation and evolution. We assume the cold dark matter (CDM) paradigm, in which galaxies form and evolve in dark matter haloes. To build our causal model, we review established theories of galaxy formation and evolution, and in particular ideas from semi-analytic modelling (SAM;; also see, for reviews), and express them as causal graphs. We carefully consider all the relevant physical processes and assemble the causal model step-by-step with mini causal models before connecting all the pieces.

We adopt a straightforward naming convention in the causal model: any variables associated with the halo and galaxy are preceded by them, respectively. Furthermore, halo refers to the dark matter halo that hosts a galaxy, and host halo refers to the parent dark matter halo that hosts other haloes. As such, halo refers to both distinct haloes and subhaloes. In the following section, we describe the galaxy formation process. Fig.shows the mini causal models of the different stages of galaxy formation and standard physical processes occurring in galaxies.

SECTION: Galaxy formation
In the very early universe, quantum fluctuations of the scalar field drive inflation and generate density perturbations in the initial matter density field, sowing the seeds for galaxy formation. The small perturbations evolve under gravitational instability as regions of space with above-average density attract matter and become denser over time. Conversely, regions of space with below-average density lose matter and become rarefied over time. The outcome is the amplification of the initial density contrast.

Once a region reaches over-density (), it breaks away from the cosmological expansion and collapses to form a dark matter halo. The primordial haloes are small as perturbations on the smallest scales collapse first. The mass and environment of the dark matter halo are a product of the evolution of the initial matter density field, or more specifically, the amplitude and pattern of the initial density perturbations, respectively. In the causal model, we loosely label this as “initial conditions”: the ‘cause’ of the initial haloes and their environment (a). Given that galaxies form in dark matter haloes, we associate nature with halo mass, and nurture to environment.

The ordinary baryonic matter falls into the gravitational potential well of the dark matter halo and is shock-heated to the haloes’ virial temperature to produce a hot gas halo that is supported against further collapse by the pressure of the gas. Thus, halo gas mass and temperature depend on halo mass (b, c). Subsequently, the hot gas can cool through various mechanisms, which removes the pressure support and causes the gas to sink to the centre of the gravitational potential well. If the angular momentum is conserved during the cooling process, the gas spins up as it flows inwards and forms a rotationally supported disc.

Primarily, two factors determine the mass of cold gas in the disc: (i) the cooling rate (i.e., the mass of gas cooled per unit time) and (ii) the free-fall time (i.e., the time taken for the cooled gas to transfer from the halo to the disc) (f). The cooling rate depends on the metallicity, temperature, and density of the halo gas (d). Specifically, the temperature and density determine the ionisation state and collision rate, respectively. The free-fall time depends on the halo mass and radius (e).

As the gas accumulates, its self-gravity dominates over that of the dark matter—and it collapses. The exact process of star formation from a self-gravitating gas cloud is unknown, but there are two theories. In the bottom-up theory, low-mass stellar cores acquire gas from the cloud in a competitive accretion process, while in the top-down theory, the gas cloud simply fragments and the sub-clouds collapse to form stars. Independent of the exact model, the star-formation rate (SFR) depends on the local density of cold gas(g, h). This is the standard paradigm of galaxy formation.

We remark that halo accretion also depends on environment, and generally, the halo and forming galaxy are subject to external processes (discussed in Section). Thus, galaxy formation depends not only on nature but also nurture.

SECTION: Galaxy evolution
In this section, we describe the internal and external processes that shape the evolution of galaxies. We do not attempt to model the different processes in detail or as accurately as possible because our goal is to estimate the overall causal effect of environment rather than of individual processes. Instead, we focus on conveying how the processes are related to halo mass and environment and their impact on galaxy properties, especially SFR. Figs.andshow the mini causal models of internal and external processes related to galaxy evolution, respectively.

As stars form, the stellar mass of a galaxy increases, and the amount of cold gas available for future star formation decreases by construction (a). The consequence of the feedback loop between galaxy gas mass and SFR is that without further accretion of gas, a galaxy will eventually die as it exhausts its cold gas and star formation ceases.

Besides the natural evolution, feedback from massive stars can actively shape a galaxy’s evolution and accelerate its demise. The most massive stars explode in a supernova at the end of their lives, and the resulting feedbackcan both positively and negatively affect SFR. For example, supernova-driven galactic winds heat the interstellar medium (ISM) and eject cold gas from the disc back to the halo, or in the extreme case, out of the halo altogether, thus suppressing star formation. Conversely, the blast waves may compress the cold gas to temporarily boost star formation. Supernovae (SNe) feedback also ejects material, which enriches the halo and galaxy gases. A more metal-rich halo gas increases the cooling rate (or shortens the cooling time), which may ultimately lead to increased star formation (c).

Supermassive black holes (SMBHs) are also important in the evolution of a galaxy because they are responsible for AGN feedback. There are two main modes of AGN feedback: the quasar mode and the radio mode. In the quasar mode, a SMBH grows via accretion of cold gas and mergers with other SMBHs (in galaxy mergers). In the radio mode, SMBHs accrete gas directly from the halo and release a vast amount of energy, heating the halo gas and suppressing cooling(f, h). In both modes, AGN feedback negatively impacts star-formation activity by diminishing the cold gas. Nevertheless, like SNe feedback, there are mechanisms whereby AGN feedback can boost SFR. In the causal model, AGN feedback represents only the ‘output’ processes.

SNe feedback depends on the initial mass function (IMF) and the SFR (b). The IMF dictates the overall fraction of stars that end up as supernovae, while the SFR determines the overall number. On the other hand, the picture for AGN feedback is far less clear as it depends on how, when, and where SMBHs form. Nevertheless, AGN feedback must scale with the mass of the SMBH(g), which depends on accretion and merger rates, but the reverse is true for the former as well, so there is a feedback loop (d). The accretion rate depends on halo and galaxy gas masses (f), while the merger rate is broadly determined by the number of galaxy mergers (e), which as will be discussed in detail in the following section, depends on halo mass and environment. In summary, there is believed to be a causal connection between AGN feedback and star-formation activity.

Overall, there are feedback cycles between halo and galaxy gases, SFR, and feedback. For example, an increase in cold galaxy gas from enhanced cooling of hot halo gas boosts star formation. A fraction of the stars born explode in a supernova, determined by the IMF, and the resulting feedback expels and/or heats the cold gas in the galaxy, transferring it back to the halo, which in turn reduces star formation. We emphasise that while the feedback theories discussed are likely to resemble reality, the fact is that the precise mechanisms are unknown. Furthermore, it is still unclear how SMBHs form in the first place.

In the following section, we describe the external environmental processes that shape a galaxy’s evolution. There are many definitions of environment, but ultimately one means the mass density field. Thus, we bear this in mind to derive the causal model.

Many processes associated with environment influence galaxies, but two of the most fundamental are accretion and mergers. The halo accretion and merger rates depend on halo mass and environment. For example, a massive halo is able to accrete more matter, but environment also plays a role since it determines the amount available for accretion. Also, a massive halo in a dense environment has to compete with neighbouring haloes to attract matter. Accretion changes halo mass and environment (assuming the local mass density field), so there is a feedback loop. Undoubtedly, a feedback loop also exists between halo mass, environment, and mergers. However, unlike accretion, mergers may not affect halo mass depending on the merger type (clarified below). In summary, halo mass (i.e., nature) and environment (i.e., nurture) influence each other via accretion and mergers in a feedback loop. In this context, we define the nature versus nurture debate in this Article (a).

Mergers are broadly categorised into two types: major and minor. A major merger occurs when the progenitors are of similar masses, and in such a merger, the progenitor haloes and galaxies merge violently to form a more massive halo with a new galaxy residing at its centre. If the progenitors are disc galaxies with a mass ratio, then the post-merger remnant resembles an elliptical. Later on, if the shock-heated and ejected gas from outflows cools with significant angular momentum, a disc forms, and then the post-merger remnant resembles an early-type spiral galaxy with a disc-bulge system. A galaxy merger is a cause of morphological transformation (b).

A period of star formation activity follows a major merger if the progenitor galaxies contain large quantities of cold gas. In the short term, the influx of cold gas and/or an increase in the galaxy gas density due to interactions between galaxies trigger starbursts. Also, the halo gas shock-heated during the merger has the opportunity to cool, leading to star formation in the long term. However, AGN feedback can prevent this from happening. If the progenitor galaxies harbour SMBHs, they may merge in the process. Additionally, the same influx of gas that fuels star formation can feed the SMBH. The subsequent growth of the SMBH from the merger and accretion can consume any leftover halo and galaxy gases (in a feedback loop) and suppress the halo gas from cooling, resulting in a galaxy devoid of star formation (b).

A minor merger occurs when the progenitors are of dissimilar masses, and in such a merger, the smaller galaxy is ‘absorbed’ by the larger galaxy. In our causal model, we have defined two types of mergers: “halo mergers” and “galaxy mergers”. As the names suggest, a halo merger refers to the merger of haloes, while a galaxy merger refers to the merger of galaxies. As such, major and minor mergers are halo mergers followed by galaxy mergers in our causal model (a). We distinguish minor mergers into “minor halo mergers” and “minor galaxy mergers”. In a minor halo merger, the haloes ‘merge’ as the smaller halo orbits within the larger halo, but the galaxies may or may not. Accordingly, we refer to it as a halo merger, but not exclusively. As in simulations, we model the halo merger with the following perspective: the smaller and larger subhaloes occupy a common host halo that is a sum of its parts.

In other words, the progenitor haloes retain their identity unless a galaxy merger follows a halo merger. Consequently, we continue referring to progenitor haloes (and the associated variables) post-merger as haloes rather than subhaloes of the host halo in the causal model.

Halo mergers are responsible for the formation of groups and clusters. In such environments, the central galaxy is the most massive and located near the centre, while the satellite galaxies orbit around it. Central galaxies reside deep in the gravitational potential well of the host halo, while satellite galaxies reside further out at different depths and distances. As a result, the environmental effect on these galaxies is asymmetrical as satellites experience most of the processes and not centrals. Satellite galaxies in these dense environments are subject to different processes that are either a consequence of, or scale with, the host halo mass.

A satellite galaxy experiences dynamical frictionas it orbits within its host halo. The drag slows down the satellite, which causes it to spiral inwards and eventually merge with the central galaxy in a process called galactic cannibalism. The magnitude of dynamical friction depends on the satellite’s halo mass and environment. For example, a satellite is subject to greater dynamical friction if it is more massive and occupies a larger host halo. Galactic cannibalism is the predominant environmental process that affects central galaxies (c).

Another critical process linked to environment is ram-pressure stripping (RPS;). As a satellite travels through the hot intergalactic medium (IGM) of groups and clusters, its relatively cold halo and galaxy gases encounter a hydrodynamical drag force due to the relative motion of the two fluids. If the drag force exceeds the satellites’ restoring force, its cold gas is ablated. Accordingly, while environment causes RPS (assuming the amount and temperature of hot gas correlates), its extent also depends on halo mass. Evidently, the depletion of gas (hot and cold) negatively impacts the SFR, and a decline in star formation affects the visual morphology of the galaxy. More specifically, a satellite galaxy that is initially spiral may resemble a lenticular (S0) galaxy. Nonetheless, there is doubt whether the effects of RPS are negative and/or permanent. For example, there is evidence that any gas not stripped may be compressed by RPS to cause an increase in star formation activity in the disc. Additionally, the stripped gas may remain bound, to later fall back and induce starbursts. In retrospect, RPS is likely to be only partially responsible for the morphology–density and SFR–density relations(d).

Groups and clusters comprise tens and upwards of hundreds of galaxies respectively, so gravitational interactions are a common occurrence. In group environments, a satellite galaxy experiences tidal forces from other galaxies. The tidal interactions can remove its cold and hot gases, stars, and dark matter via tidal stripping. As was the case with RPS, the effectiveness of tidal stripping depends on environment (the number of interactions is related to the density) and halo mass. Note that there is a feedback loop between tidal stripping and halo mass, so the process becomes more effective over time(e).

In cluster environments, satellite galaxies are typically not subject to tidal stripping and mergers (not resulting from dynamical friction) because strong gravitational interactions are infrequent due to their high velocities. Instead, they are subject to multiple, weak interactions, and the cumulative effect of such interactions is called galaxy harassment. The high-speed encounters can impulsively heat the disc of a satellite galaxy, which pushes its stars onto elliptical orbits, and the disc transforms into a spheroidal component, thus altering its morphology. At its extreme, the stars can become completely unbound, which decreases the galaxy’s stellar mass. The heating of the disc naturally impacts the SFR as it affects the density of the cold gas (via a change in the galaxy gas mass and/or radius). Galaxy harassment scales with the number and strength of interactions, which depends on environment, and resistance to its effects depends on halo mass, like tidal stripping (f).

The hot halo surrounding a galaxy is in constant flux as the gas condenses to form stars, and the subsequent feedback returns the cold gas back to the halo. Simply put, the hot gas acts as a reservoir for future star formation. The combination of RPS and tidal stripping can annihilate this reservoir, and without further accretion in a dense environment, a satellite galaxy eventually stops forming stars as it exhausts its fuel. This process is called strangulation. We do not have a specific node for it in our causal model because it is not a process in and of itself and is already captured by the existing variables. Also, we do not have nodes for thermal evaporationand viscous strippingbecause they are variants of RPS. Furthermore, whilst important, variables such as colour, stellar metallicity, and luminosity are not included as they are not the subject of this study.

Finally, we have not precisely defined or modelled morphology and related processes because our target is the SFR–density relation. Nonetheless, internal dynamical effects can change the morphology of galaxies, a well-known example being the bar instability. A thin disc with high surface density is susceptible to a non-axisymmetric instability, which creates a bar-like structure. Bars can funnel gas to the central region of a galaxy, which can fuel AGNs and star formation. The bar may also buckle to produce a “pseudobulge”, which can prevent the disc from collapsing and forming stars. Additionally, there is a strong connection between bulges and SMBHs (; also see, for a review). Thus, morphology can directly and indirectly influence SFR (and vice versa). Still, detailed modelling of morphology is unnecessary to estimate the SFR–density relation because it is not a confounding factor given that it does not also impact environment. In fact, controlling for morphology may induce selection bias (Fig.) since it is a common effect of environment and SFR.

The key findings are: (i) galaxy formation and evolution depends on nature and nurture, (ii) nature (i.e., halo mass) and nurture (i.e., environment) influence each other through accretion and mergers, and (iii) internal processes associated with nature also depend on nurture, and external processes associated with nurture also depend on nature, as both halo mass and environment determine their impact on galaxies. In conclusion, nature and nurture are heavily intertwined. Fig.shows the causal model of galaxy formation and evolution in its entirety with all the mini causal models and variables connected.

SECTION: Inverse probability weighting of marginal structural models
In this section, we describe the causal inference method we apply to disentangle nature and nurture and estimate the causal effect of enviroment on SFR: inverse probability weighting (IPW) of marginal structural models (MSMs;). We begin by introducing its key component—the propensity score.

SECTION: Propensity score
The propensity score (PS;) is the conditional probability of treatment given covariates,

An extension of the propensity score to continuous treatments is the generalized propensity score (GPS;),

whereis the conditional probability density function (PDF). For conciseness, we refer to the GPS as simply the propensity score from hereon. Furthermore, we denoteasin the equations even when the treatment is binary because the concept is the same. A propensity score close to zero or one means there is a low or high probability of receiving the specific treatment given covariates, respectively. Essentially, the propensity score represents the dependence of treatment on covariates. As treatment dependence correlates with confounding bias when the covariates are confounders, the propensity score can adjust for confounding to estimate causal effects. There are four known techniques to adjust using the propensity score:

– Units from the treatment group are matched to their counterparts in the control group based on their propensity scores. This process makes the treatment and control groups comparable in terms of their covariate distributions, which ultimately means they are exchangeable. As explained in more detail in Appendix, exchangeability ensures no confounding.

– The population is divided into distinct strata or subgroups based on the propensity score. This negates any confounding effect because within each stratum the level of confounding is similar.

– The propensity score is included along with the treatment as a covariate in a model to predict the outcome.

– Units are weighted according to their propensity score. We discuss how this eliminates confounding bias in the following section.

Previous studies have employed matching, stratification, and covariate adjustment to eliminate confounding bias, but just not with the propensity score. For example, the common approach of binning galaxies according to their stellar mass is a form of stratification. Also, galaxies have been matched on redshift and stellar mass when creating a treatment and control group, and stellar mass has been included as a variable in models. We use the IPW approachas the other techniques are either unable or unsuitable to disentangle nature and nurture. Stratification and covariate adjustment are conditional approachesand thus cannot estimate the joint effect, and there is no clear strategy with matching. The conditional approach is to block the backdoor path between the treatment and outcome by conditioning on the confounder (as described in Section). The act of conditioning stops the flow of non-causal confounding association via the confounder (Fig.b), which means that all association is causal and the causal effect is unbiased. See Sectionfor definitions of the marginal and joint causal effects.

SECTION: Inverse probability weighting
In this section, we first describe the IPW method for time-fixed treatments and then extend it to time-varying treatments.

IPW is a statistical technique that adjusts for confounding bias by weighting each unit with the inverse of their probability of receiving treatment, i.e., the propensity score.

Intuitively, the propensity score quantifies the magnitude of confounding bias, so weighting each unit with its propensity score directly negates the influence of confounders. Specifically, the method works as follows: a unit with a high propensity score implies the treatment it received is likely given the confounders. In other words, the influence of the confounders is significant, so the unit is down-weighted to reduce its impact. Conversely, a unit with a low propensity score implies that the treatment it received is unlikely given the confounders. Crucially, such a unit is a counterfactual of units that received a different treatment, and thus it is up-weighted because it holds valuable information. In a sense, IPW is comparable to the technique of importance sampling. Overall, assigning weights to each unit creates a pseudo-population in which treatment is independent of confounders, and thus IPW is a marginal approach. The marginal approach is to remove the backdoor path entirely by making the treatment independent of the confounder, as achieved experimentally with RCTs. Visually, this translates to no direct edge (i.e., arrow) from the confounder to the treatment in a DAG. By removing the backdoor path, confounding bias is eliminated altogether.

Units with specific characteristics that predispose them to a particular treatment, or from the alternative viewpoint, units subject to a treatment confined to a subpopulation, will have propensity scores close to zero or one because of the strong causal association between the covariates and treatment. Consequently, a disproportionately small fraction of units can dominate and drastically skew the causal effect. A simple solution is to truncate or trim the extreme weights from the analysis, typically at the 1st and 99th percentiles. However, a better approach is to stabilise the weights with the marginal probability of treatmentsuch that,

Besides counteracting the effect of extreme weights, stabilised weights generally reduce the variance of causal effect estimates. Furthermore, when the treatment is continuous, unstabilised weights are not an option as they have infinite variance. For binary or discrete treatments,

whereis an indicator function that isifandotherwise. Thus, the ACE of a binary treatment,

Using the Horvitz-Thompson estimator,

whereis the number of units. Therefore, ACEs of binary treatments can be directly estimated using the weights. However, this is not the case for continuous treatments as the estimand (equation ()) is biased forand is not valid. For continuous treatments, a model that describes the causal relationship between the treatment and outcome is necessary. One such class of causal models are MSMs. A MSM is a model for the potential outcome under treatment, for example,

Unlike ‘regular’ models, MSMs consider the expected outcome under different treatments, which is not observable due to the “fundamental problem of causal inference”. Nonetheless, it is possible to reliably estimate MSMs with IPW adjustment because if the causal assumptions are met, the MSM is equal to:

The parameters of MSMs have causal interpretations. For example,represents the ACE in the case of binary treatments. To summarise, weights are applied to fit a MSM to estimate ACEs of continuous treatments (and also binary treatments). As there are an infinite number of values when a variable is continuous, the goal with continuous treatments is to estimate the causal dose-response curve (CDRC),, rather than a single causal effect.

The weights in their current form are valid for causal effects of time-fixed treatments and marginal causal effects of time-varying treatments but may not sufficiently adjust to estimate joint causal effects of time-varying treatments. Thus, we describe the extension of the method to joint effects in the following section.

Time-varying treatments affected by time-varying confounders necessitate adjustments to eliminate confounding bias as before. However, unlike time-fixed treatments, simply adjusting for all the confounders together in the presence of treatment-confounder feedback fails when the goal is to estimate the joint effect. Suppose we adjust for halo massessince it is the time-varying confounder in the causal model (Fig.a). Accordingly, there are no direct paths fromto time-varying treatments, so there is no confounding bias. But, since the same paths constitute causal pathways ofto outcomes, the joint effect now suffers from over-adjustment bias. This scenario is exactly the same as encountered with conditional approaches where the joint effect is biased whether one adjusts for confounders or not. The solution to the dilemma is simple: adjust for biases step-by-step rather than all at once.

With joint effects, the idea is to repeat the IPW process to adjust for biases at each time point. The exact method is as follows: estimate weights for each time point and then multiply them together to construct a final weight. This strategy eliminates confounding bias without introducing over-adjustment bias, so there is no overall bias. The method creates pseudo-populations at each time point, so the principle is the same as with time-fixed treatments. The general form of stabilised weights at time point,

whereis the treatment at time point,is the treatment history up until the time point, andis the confounder history to the time point. The numerator is the conditional PDF of the current treatment given the previous treatment history, and the denominator is the conditional PDF of the current treatment given previous treatment and confounder histories. Compared to the weights for time-fixed treatments, the treatment history is conditioned on because time-varying treatments can be, and are, confounders if the previous treatments influence the current treatment and outcome from the perspective of a point in time. As before, the weights are applied to fit a MSM to estimate joint causal effects of interest. In summary, IPW of MSMs consists of: (i) estimating weights to adjust for biases and (ii) fitting a MSM using the weights to estimate causal effects. We apply the methodology to estimate the causal effect of environment.

SECTION: Validation
In this section, we verify the validity of our results by qualitatively and quantitatively checking whether the key causal assumption stated in Sectionare met. They are exchangeability, positivity, consistency, and no interference.

The exchangeability assumption states that potential outcomes must be independent of the treatment. In other words, it must be possible to swap treatment groups without changing their potential outcomes. To achieve exchangeability, it is necessary to adjust for any confounders and thus we adjusted for halo mass, the time-varying confounder in the causal model (Fig.a). Whether or not the assumption is actually satisfied is untestable due to the possibility of unobserved confounders. We believe we have considered most (if not all) known fundamental aspects of galaxy formation and evolution to build the causal model (Fig.), and it is difficult to think of a physical process or variable (besides halo mass) that could causally affect both environment and SFR. Consequently, we are fairly satisfied that there is no unobserved confounding.

Positivity states that there must be a non-zero probability of receiving any treatment. In the context of this study, galaxies of all halo masses (or stellar masses, due to their correlation) must have some probability of occupying different environments to reliably estimate the causal effect of environment at any particular density. This is reasonably true according to the halo/stellar mass–environment distribution in, which shows a relatively uniform halo/stellar mass coverage at different environmental densities. Though, in the lowest density environments, there is a lack of the least and the most massive haloes. To alleviate this positivity violation, we have defined the treatment grid between the 1st and 99th percentiles of the environmental density distribution, so environments at both extremes are not considered.

Consistency states that the observed outcome must equal the potential outcome under treatment. In other words, the treatment must be well-defined. The treatment in our case is the environment, which has no universal definition, and this opens up the possibility of violating the assumption. We employ the 10th nearest neighbour density, and as long as the proxy consistently measures the environmental density in varied environments and the effect of environment is similar at a particular density, we satisfy the consistency assumption.

Lastly, the no interference assumption states that the potential outcome of a unit must only depend on its treatment. This assumption is irrelevant in our case because galaxies in close proximity are roughly in the same environment, so they are subject to the same treatment. We are concerned about neighbourhood-level no interference, which means that a galaxy’s SFR must only depend on its environment and not the neighbouring environment. It is hard to imagine a physical mechanism that would result in the above being untrue, so we are reasonably confident that the no interference assumption holds. In summary, we believe the consistency and no interference assumptions hold. In the following section, we quantitatively verify exchangeability (assuming no unobserved confounders) and positivity.

SECTION: Diagnostic tests
The critical component of our causal analysis is the weights, which we utilise to capture and adjust biases via the IPW method to estimate MSMs. Their validity directly translates to unbiased causal effects, which means they can provide clues on the satisfaction of the causal assumptions. As a result, we perform diagnostic tests on them to check exchangeability and positivity. We highlight that we conduct the tests on the weights estimated from the non-bootstrapped analysis.

The goal of IPW is to create a pseudo-population in which the treatment is independent, and this produces exchangeability as the treatment groups are comparable in terms of their covariate distributions when the treatment does not depend on anything. We assess the covariate balance using the correlation-based method ofto determine exchangeability. The basic premise is to determine the correlation between the confounders and treatment in the pseudo-population, and if it is minimal, then the treatment is independent, there is no confounding, and exchangeability is achieved. The exact procedure is as follows:

Sample data with replacement from the original dataset according to the weights.

Compute the correlation coefficientbetween confounderand treatmentin the weighted sample.

Repeat the above stepstimes and calculate the average correlation coefficient.

Finally, average the absolute values of all the average correlation coefficients to compute the average absolute correlation coefficient.

We assess the covariate balance at each time point. Accordingly, the data is sampled per the time-point weights, not the final product weights. For consistency, the correlation coefficients are computed with the previous environmentsand halo masseseven though the confounders of the current environmentand star-formation ratemay only be the prior environmentand halo mass. Specifically, Kendall’s tau coefficientis estimated because the halo mass and environment distributions are not normal, and the relationship between them is non-linear (as can be observed in). In total,bootstrap samples are generated to calculate the average correlation coefficients.

Fig.shows theat the different redshifts in the original population before weighting and in the pseudo-population after weighting.claim that there is minimal confounding when, medium confounding when, and large confounding when. However, these limits are based on heuristics, and there is no theoreticalvalue for exchangeability. In this case, the relative change in theis more important than the absolute value. As observed, there is a clear decrease in thepost weighting across all the redshifts, which indicates that IPW has reduced confounding and improved exchangeability.

The mean of the stabilised weights is expected to be one because the size of the pseudo-population equals that of the original population. Crucially, significant deviations indicate misspecification of the weighting model, violation of positivity, or both. However, as is the case with the, there is no reference value. Fig.shows the weight distributions at the different redshifts. The means are close to one, so our causal model seems to be valid, and positivity is not violated. Based on the reasoning and diagnostics, the causal assumptions seem to have been met or at least not grossly violated (although it cannot be definitively proven). Thus, the results can be considered valid.

SECTION: Additional results