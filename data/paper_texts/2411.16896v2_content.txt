SECTION: Enhancing Fluorescence Lifetime Parameter Estimation Accuracy with Differential Transformer Based Deep Learning Model Incorporating Pixelwise Instrument Response Function

[supp-]osa-supplemental-document-template

Fluorescence Lifetime Imaging (FLI) is a critical molecular imaging modality that provides unique information about the tissue microenvironment, which is invaluable for biomedical applications. FLI operates by acquiring and analyzing photon time-of-arrival histograms to extract quantitative parameters associated with temporal fluorescence decay. These histograms are influenced by the intrinsic properties of the fluorophore, instrument parameters, time-of-flight distributions associated with pixel-wise variations in the topographic and optical characteristics of the sample. Recent advancements in Deep Learning (DL) have enabled improved fluorescence lifetime parameter estimation. However, existing models are primarily designed for planar surface samples, limiting their applicability in translational scenarios involving complex surface profiles, such asin-vivowhole-animal or imaged guided surgical applications. To address this limitation, we present MFliNet (Macroscopic FLI Network), a novel DL architecture that integrates the Instrument Response Function (IRF) as an additional input alongside experimental photon time-of-arrival histograms. Leveraging the capabilities of a Differential Transformer encoder-decoder architecture, MFliNet effectively focuses on critical input features, such as variations in photon time-of-arrival distributions. We evaluate MFliNet using rigorously designed tissue-mimicking phantoms and preclinicalin-vivocancer xenograft models. Our results demonstrate the model’s robustness and suitability for complex macroscopic FLI applications, offering new opportunities for advanced biomedical imaging in diverse and challenging settings.

SECTION: 1Introduction

Fluorescence lifetime imaging (FLI) is a powerful molecular imaging technique with high sensitivity and the ability to provide unique signatures with high specificity[1,2]. Fluorescence lifetime and its associated parameters enable multiplexing studies[3,4,5]and can report on numerous unique biological signatures, including micro-environmental parameters, protein conformations, metabolic states, protein-protein interactions, and/or ligand-target engagement[6,7,8,9]. FLI has known constant growth over the last three decades, with a significant acceleration in its dissemination thanks to the availability of a user-friendly FLI microscope[10,11,12]. In parallel, over the last two decades, FLI has found an increased utility in translational applications, ranging from the mesoscopic (mFLI)[13]to the macroscopic regime (MFLI)[14,15,16]. Compared to microscopic implementations, mFLI and MFLI are significantly more challenging due to the requirement of using Near Infrared (NIR) fluorophores for deeper tissue penetration. As fluorophores are red shifted, it is typical that their lifetimes are shorter (nanosecond (ns) or sub-nanosecond compared to few nanoseconds in the visible)[16]whereas large-format detectors exhibit low quantum efficiency (a few percent only)[17,18]. Hence, quantifying lifetime and its associated parameters can be challenging due to very short fluorescence decays and/or low photon counts[19,20,21,22]. Unlike microscopic imaging, where the sample preparation allows for precise control over the imaging plane, mFLI, and MFLI samples can exhibit a large depth of field (DOF). These lead to significant variations in the time of arrival of the acquired data, which needs also be taken into account for accurate lifetime quantification. This is especially important in clinical systems, such as endoscopic or fluorescence-guided surgical instruments in which the tissue profiles can lead to DOF variations of a few centimeters.

To address these challenges, understanding the underlying methodology for estimating lifetime parameters becomes important. In mFLI and MFLI, lifetime parameters can be estimated by deconvolving the temporal point spread function (TPSF) and instrument response function (IRF). TPSF is the temporal histogram of the acquired fluorescence photons exiting the surface of the sample after a pulse excitation. The IRF represents the temporal response of the imaging system to pulsed illumination[23]. Considering the complexity involved in estimating FLI parameters across diverse imaging conditions, fast and advanced data processing techniques are necessary to enhance both the precision and efficiency of these analyses. Recently, the field has seen a shift toward rapid, fit-free deep learning (DL) methodologies to alleviate the computational burden and reliance on user expertise, typically associated with methods such as nonlinear least squares fitting (NLSF) for FLI parameter estimation[24,25]. This advancement makes real-time FLI a possibility[26,27], driven by the development of novel DL methods that eliminate traditional time-consuming computational approaches. FLI-Net, a DL model developed for FLI parameter estimation[28], is used to analyze FLI data quickly, producing 2D quantitative images of the lifetimes and corresponding parameters directly without requiring manual parameter adjustments, outputting 2D quantitative images of the lifetime parameters directly. FLI-Net is versatile in terms of the imaging domain, including visible and near-infrared (NIR) imaging, making it adaptable to a large range of biomedical applications. FLI-Net takes the TPSF as an input and outputs FLI parameters. The experimental IRF was used in data generation of the training data; hence, it was represented in the TPSFs. However, FLI-Net was not designed to analyze pixel-wise IRFs while it predicts the lifetime parameters.

Despite the advancements in deep learning for FLI data analysis, the lack of pixel-wise IRF considerations poses limitations. The IRF integrates both the excitation part (including the laser source temporal profile) and detection (including the electronic limited reaction time) aspects of the optical setup. The complex broadening or distortion of the intrinsic fluorescence decay is caused by the detection part of the IRF from imaging system characteristics; however, the temporal offset in the IRF is caused by the photon time-of-arrival delays caused by the distance between the imager and sample surface[22]. Hence, topographic variations in the sample surface can lead to variations in delays in photon arrival times per pixel. In such cases, it is important to incorporate pixel-wise IRF in the FLI data processing pipeline. To address these limitations and consider the essential role of the IRF in accurate FLI parameter estimation, we propose a novel deep-learning approach tailored specifically for processing FLI data.

Following the developments in DL models, we leverage herein the ability of transformers to handle sequential data. Generally, transformers have a natural ability to capture long-range connections within data[29,30,31,32]. In the context of FLI, they can effectively identify and learn the relationships between the TPSF and IRF for accurate lifetime estimation. Furthermore, the self-attention mechanism in transformers allows them to focus on the most relevant parts of the input data for making predictions[32]. Recently, Differential Transformer (DIFF Transformer) as been proposed as a new approach to amplify attention to the relevant task while canceling noise[33]. MFliNet architecture is based on a novel decoder layer design that integrates the DIFF Transformer for the first time in literature, improving the model’s adaptability to account for shifts caused by variations in the DOF. The DIFF Transformer employs a differential attention mechanism, which calculates attention scores as the difference between two separate softmax attention maps, effectively canceling noise. This cancellation mechanism encourages sparse attention patterns, intensifying the focus on relevant contextual data while reducing distractions caused by irrelevant input. Analogous to noise-canceling systems, this approach mitigates the problem of over-allocating attention to non-critical information, a common issue with traditional transformers. DIFF Transformers outperform conventional transformers across various domains, especially in long-context modeling, key information retrieval, and robustness against variability in input structure. In the context of Time-Resolved FLI, these characteristics enable the detection of critical patterns even in low signal-to-noise scenarios, achieving higher accuracy and robustness compared to standard transformer architectures. These advancements mark a significant progression in FLI methodologies, offering a more effective tool for handling complex biological and imaging variability.

SECTION: 2Methods

SECTION: 2.1Imaging setup

All experimental data used in this work were captured on our MFLI system, detailed information about which can be found in[34]. Briefly, the system uses a large-format Intensified Charge-Coupled Device (ICCD) camera (Picostar HR, LaVision GmbH, Germany), for wide-field detection over acm2in combination with a Digital micro-mirrors device (DMD) (DLi 4110, Texas Instruments, TX, USA), for wide-field illumination. As an excitation source, we used a tunable Ti-Sapphire laser (Mai Tai HP, Spectra-Physics, CA, USA), which deliversfemtosecond pulses atMHz. A gate width of 300 picoseconds (ps) and gate delay ofps were used for capturing time-resolved fluorescence decays (forin-vivoandin-vitroexperiments) with a total of 176 time points, which is referred to as a number of gates (G=176). An emission filter atnm (FF01-740/13-25, Semrock, IL, Rochester, NY, USA) is used to capture the TPSFs, with the laser set at anm wavelength.

SECTION: 2.2Generation of training data and classical Fluorescence lifetime processing

Fluorescence Lifetime decay follows exponential decay. Depending on the number of components present in the sample, the decay kinetics can be described by a combination of multi-exponential functions. Most FLI imaging experiments involve up to two components, hence a bi-exponential model is typically used. The two-component or bi-exponential model also includes mono-exponential cases (where fractional amplitudesare one or zero). Mathematically, the TPSF is the convolution of the IRF and the fluorescence decay associated with the lifetime parameters as shown in Eq.1, where lifetime decays are denoted as,, andis the amplitude fraction.

Thein-silicodata used for training and validating the proposed model was generated using Eq.1. Initially, time-resolved fluorescence lifetime images with dimensions ofpixels were generated by using the MNIST dataset. Fluorescence decays were generated for a range of lifetime values commonly used in NIR applications:ns tons for(short-lifetime component) andns tons for(long-lifetime component). The range of the(fraction amplitude) was set from 0% to 100%, respectively (both bounds corresponding to mono-exponential cases). To ensure that our simulated data accurately represents experimental applications, pixel-wise IRFs were used. To capture experimental IRFs, a white diffused paper was placed on the imaging table and illuminated using the DMD with an excitation wavelength of 700 nm. The reflected light was captured using a neutral density (ND) filter. Subsequently, each TPSF was generated by convolving randomly selected IRF from the dataset with simulated fluorescence decay profiles. To approximate the noise characteristics of real-world measurements, system-derived noise, including read-out noise, dark noise, etc., as explained in[34], was incorporated into the simulated TPSFs. This approach ensures that the simulated data closely matches the noise dynamics observed in the actual system.

To evaluate and compare the model’s performance in the absence of experimental ground truth, we used the NLSF method, which is commonly used to estimate the FLI parameters described in Eq.1. Traditionally, FLI parameters are estimated from experimental data through iterative fitting optimization methods such as the NLSF, which incorporates the Levenberg-Marquardt algorithm[35], or center of mass (CMM) analysis[36]. For our NLSF analysis, we utilized a software named AlliGator[37], allowing adjustments and constraints on fitting parameters, including short and long lifetimes, fraction amplitudes, and offsets, depending on experimental conditions. We selected between single and double exponential decay models according to the complexity of our datasets. AlliGator also provides an option for offset correction when there is a mismatch between the TPSF and IRF. We evaluated the importance of offset correction in our NLSF analysis by comparing data with and without this feature in our phantom experiments. Additionally, we benchmarked our results against those obtained using FLI-Net and to provide a comprehensive evaluation of our approach in the context of established methodologies. Furthermore, to assess the impact of the DIFF Transformer model, we compared our results with those from a transformer model of same architecture and parameters, trained on the same dataset.

SECTION: 2.3Deep learning network architecture

MFliNet is a novel architecture designed for FLI parameter estimation, particularly effective under varying IRFs. The model leverages a DIFF Transformer framework, incorporating a unique differential attention mechanism to enhance feature extraction while mitigating the effects of noise. The theoretical background on the differential attention mechanism is detailed in[33].

At the core of MFliNet is the differential attention mechanism, which computes attention scores by contrasting two separate multi-head attention outputs. Specifically, the mechanism calculates the difference between two attention maps, scaled by a parameter, to focus on relevant patterns and suppress noise. The differential attention is defined as:

where:

are the query, key, and value matrices for the first attention head, derived from the inputusing learned projections.

are the query, key, and value matrices for the second attention head, also derived from.

is the dimensionality of the key vectors.

is a learnable scalar parameter that balances the contributions of the two attention maps.

The queries, keys, and values are computed as:

where,, andare the learned weight matrices for the-th attention head.

This differential attention mechanism enhances the model’s ability to focus on critical features by emphasizing the differences between two attention outputs, effectively reducing the impact of noise. The parametercontrols the degree to which the second attention output is subtracted from the first.

Each input sequence passes through two stacked encoder blocks, each comprising a differential attention layer, followed by layer normalization and a feed-forward network (FFN) with SwiGLU activation. The encoder block operates as follows:

where the feed-forward network is defined as:

withbeing learned weight matrices,bias vectors,representing element-wise multiplication, andSwishbeing the activation function defined as, whereis the sigmoid function.

The decoder blocks incorporate both self-attention and cross-attention mechanisms. The self-attention layer within the decoder uses the differential attention mechanism to capture intra-sequence relationships. The cross-attention layer aligns the decoder’s inputs with the encoder outputs, integrating information from both inputs. The decoder block operates as:

whererepresents the encoder outputs from the corresponding input sequence, and the standard attention mechanism is defined as:

MFliNet’s architecture includes three parallel output pathways, each dedicated to predicting one of the FLI parameters: short lifetime, long lifetime, and fractional amplitude. Each pathway processes the decoder outputs through additional layers to refine the predictions.

The final outputs are obtained by reshaping the decoder outputs and applying a convolutional layer with kernel size, using the Exponential Linear Unit (ELU) activation function and L2 regularization to prevent overfitting:

wheredenotes a 2D convolutional layer with ELU activation and L2 regularization applied to the reshaped decoder output corresponding to each parameter.

Training was conducted using the Adam optimizer with an adaptive learning rate starting from 0.001. The loss function for each output branch was Mean Squared Error (MSE). The dataset comprised 2,000 samples (totaling 1,568,000 generated time-resolved photon signals and corresponding IRFs), with 10% reserved for validation. The model’s design allows it to capture both local and global patterns in the data, effectively modeling variations in time-domain signals and encoding the relationships between inputs and FLI parameters.

SECTION: 2.4Phantom preparation

For experimental validation, we designed a step ladder phantom to introduce variations in sample-detector distance, as depicted in Figure2(a). A 3D printable case was designed to accommodate five discrete containers arranged at various heights: ground level,mm,mm,mm, andmm. Each container was crafted with dimensions ofmm3to accommodate tissue-mimicking phantoms. The phantoms were made with agar constituting 1% of the total volume (cm3). To prepare the phantoms, agar was first fully dissolved in distilled water by heating, and then allowed to cool slightly before further processing. The optical properties of the phantoms (absorption coefficient () ofmm-1and reduced scattering coefficient () ofmm-1) were controlled through the addition of India Ink and intralipid solutions, to provide absorption and scattering contrasts respectively[38]. In each ladder step, a specific area was designated for the placement of a cuboidal fluorescence embedding, with dimensions ofmm3. This embedding consisted of Alexa Fluor 700 dye dissolved in phosphate-buffered saline to achieve a concentration ofM. The embeddings were placed at a depth ofmm from the surface of each phantom.

To examine the offset variation across different heights on the phantom and in live intact animals, we plotted the pixelwise IRFs for comparison as shown in Figure2. For each specified height in the step ladder phantom, we plotted the average IRFs in Figure2(a). Moreover, we also illustrated the IRFs of various anatomical regions in live intact animals, including the liver, urinary bladder (UB), and tumors, in Figure2(b). Lastly, in Figure2(c), we examined the variability of the IRF within a single tumor. This plot contains IRFs on three points within a tumor: the top, middle, and bottom. The top refers to an IRF from the upper region of the tumor, the middle corresponds to an IRF from the central area in terms of height, and the bottom shows an IRF from the lowest part of the tumor.

SECTION: 2.5In-vivoexperiment

Forin-vivoMFLI imaging experiments, we imaged HER2+ breast tumor xenografts HCC1954 in athymic nude mice. The cell line was sourced from ATCC (Manassas, VA, USA) and maintained in RPMI 1640 media enriched with 10% fetal bovine serum (ATCC) andunits/mL/µg/mL penicillin/streptomycin from ThermoFisher Scientific (Waltham, MA, USA). We initiated tumor xenografts by subcutaneously injectingHCC1954 cells suspended in PBS and mixed in aratio with Cultrex BME (R&D Systems Inc, Minneapolis, MN, USA) into the inguinal mammary fat pads of female athymic nude mice aged 4 weeks (CrTac: NCR-Foxn1nu, Taconic Biosciences, Rensselaer, NY, USA). Tumors were monitored daily for 4 weeks. The mouse was administered with a retro-orbital injection of AF700 conjugated with Meditope Trastuzumab (MDT-TZM) (MDT-TZM-AF700) atµg and AF750 conjugated with MDT-TZM (MDT-TZM-AF750) atµg in aacceptor to donor ratio through staggered injection[9]. Donor injection was performed 2 hours ahead of acceptor injection through the retro-orbital route. MFLI Imaging was conducted 24 hours post-injection. Throughout the imaging process, the mouse was anesthetized with isoflurane, and the body temperature was maintained with a Rodent Warmer X2 (Stoelting, IL, USA). All animal procedures were conducted with the approval of the Institutional Animal Care and Use Committee (IACUC) at both Rensselaer Polytechnic Institute and Albany Medical College. The animal facilities of both institutions have been accredited by the American Association for Accreditation for Laboratory Animals Care International.

SECTION: 3Results

We conducted the ladder phantom experiment designed to validate the MFliNet model under controlled conditions that mimic biological tissues. Figure3shows the phantom experiment results where the analysis was done using four methods: NLSF, FLI-Net, transformer model and MFliNet. To compare the precision and stability of each method under varying conditions reflective of real-world applications, results were evaluated across five different heights: ground,mm,mm,mm, andmm. Aps shift in the IRF was observed from ground level to a height ofmm, with a shift of approximatelyps for eachmm increment in height. For simplicity in comparison, the amplitude-weighted average lifetime was calculated using Eq.17, for all outputs.

NLSF analysis using pixel-wise IRF showed consistency in lifetime estimation across all tested heights. The mean fluorescence lifetime values obtained by NLSF were clustered aroundns. NLSF without offset correction results deteriorated with each increase in height. At the ground level, NLSF without offset correction began with a mean value ofns. However, as the height increased, a steady decline in lifetime estimation was observed, reaching a mean value ofns atmm. FLI-Net, in contrast, demonstrated a wider variation in estimated fluorescence lifetime values. At the ground level, it reported a mean value ofns, which was lower than the NLSF values. As the distance increased, FLI-Net’s estimations deviated further, peaking atns atmm and estimatingmm with a mean value ofns. The transformer model showed variable performance across different heights; at 10 mm, a decrease was observed with a mean value ofns, while estimations at other heights were closer to the NLSF values. In contrast, MFliNet, showed closer results with NLSF, where the mean values were within the same range as NLSF. Moreover, in terms of processing speed, NLSF took approximately 6 hours to analyze 598 pixels (covering only the tumor area), whereas MFliNet analyzed the entire dataset of 90,480 pixels in just 63 seconds.

Following the phantom studies,in-vivoexperiments were conducted using the HER2+ breast tumor xenograft model in mice to evaluate the model’s performance in a more complex, biologically variable environment. The experimental results, illustrated in Figure4, demonstrate the comparative analysis of NLSF and MFliNet in HER2+ HCC1954 tumor xenograft mice model. For the smaller tumor (HCC1954 (A)), the NLSF method reported a short fluorescence lifetime ofns and a long lifetime ofns. The MFliNet showed a comparable short lifetime ofns and a long lifetime ofns. In the case of the larger tumor (HCC1954 (B)), the NLSF method reported a short fluorescence lifetime ofns and MFliNet showed a comparable short lifetime ofns. For the long lifetime, both methods again yielded closely aligned values:ns for NLSF andns for MFliNet.

SECTION: 4Discussion and Conclusion

In this study, we introduced MFliNet, a novel deep learning model based on the DIFF Transformer architecture, to address the challenges of accurate FLI parameter estimation, particularly in complex and variable biological environments. Our results, as illustrated in Figure2, demonstrate shifts in IRFs at varying heights, highlighting how each organ’s unique geometry and composition contribute to IRF offsets. This variation in the IRF offset underscores the challenge of accurately estimating the FLI parameters and the necessity for MFliNet, which can adapt to these complexities. The integration of pixel-wise IRF analysis within MFliNet specifically addresses the effects of surface irregularities on early photon arrival times, which is often overlooked in other DL models. By comparing MFliNet with a standard transformer model of same architecture and parameters, we demonstrated that the differential attention mechanism inherent in the DIFF Transformer enhances the model’s ability to focus on relevant features while suppressing noise, leading to improved FLI parameter estimation.

Comparative analysis indicates that MFliNet not only matches the accuracy of NLSF analysis but also enhances processing speed. MFliNet eliminates the need for manual user dependency and extensive user training, making it better suited for real-time applications. In addition, as shown in the phantom experiment, an increasing trend in lifetime estimations from the FLI-Net suggests a distance-related bias, which reflects an underlying limitation in the model’s ability to account for variations in time-of-flight. The effect of the IRF offset on lifetime estimation is further validated through NLSF analysis without using the offset correction, where lifetime estimations result in noticeable declines, potentially leading to systematic underestimations of fluorescence lifetimes and inaccuracies in diagnostics.

The significance of these improvements is particularly relevant in complex imaging environments such as fluorescence-guided surgery (FGS), where the understanding of these variables can significantly impact the quality of imaging and, consequently, the surgical outcomes. Potential integration of MFliNet with existing FGS systems can lead to the development of advanced surgical guidance systems that offer real-time, precise imaging for cancer surgery[39]. Moreover, the capabilities of MFliNet extend beyond clinical applications, offering potential benefits in various research applications. In drug development, for instance, MFliNet’s enhanced accuracy could be used to determine drug-target interactions more precisely, thus accelerating the development of therapeutics by providing clearer insights into molecular engagements. Additionally, in biological research, the improved measurement accuracy of molecular interactions facilitated by MFliNet could foster a deeper understanding of cellular functions and disease mechanisms. This could open new avenues for exploring and developing targeted therapies. This work contributes to the field by providing a robust and efficient tool for FLI parameter estimation, with potential applications in clinical diagnostics, fluorescence-guided surgery, and various biomedical research areas.

Funding
This work was supported by the National Institutes of
267 Health (NIH) Grants R01CA237267, R01CA250636, R01CA271371, & R01CA250636-02S1.

Acknowledgment
The authors thank Dr. Xavier Michalet for his support with the AlliGator software.

Disclosures
The authors declare no conflicts of interest.\bmsectionData availability Data underlying the results presented in this paper are not publicly available at this time but may be obtained from the authors upon reasonable request.

SECTION: References